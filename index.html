<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔄 Trading Calculator - Compact</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 15px;
        display: flex;
        justify-content: flex-end;
        align-items: flex-start;
    }

    .container {
        width: 350px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        overflow: hidden;
        position: sticky;
        top: 15px;
    }

    .header {
        background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
        color: white;
        padding: 15px 20px;
        text-align: center;
    }

    .header h1 {
        font-size: 1.2rem;
        margin-bottom: 3px;
    }

    .status {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 12px;
        background: #f8f9fa;
    }

    .status-box {
        text-align: center;
        padding: 8px;
        background: white;
        border-radius: 6px;
        font-size: 0.8rem;
    }

    .status-label {
        color: #666;
        font-weight: 600;
        font-size: 0.65rem;
    }

    .status-value {
        font-weight: 700;
        color: #333;
        margin-top: 2px;
        font-size: 0.9rem;
    }

    .tabs {
        display: flex;
        background: #f8f9fa;
    }

    .tab {
        flex: 1;
        padding: 10px 4px;
        text-align: center;
        background: #e9ecef;
        border: none;
        cursor: pointer;
        font-size: 0.65rem;
        font-weight: 600;
        transition: all 0.3s;
    }

    .tab.active {
        background: white;
        color: #4ECDC4;
    }

    .tab-content {
        display: none;
        padding: 12px;
        min-height: 350px;
        max-height: 400px;
        overflow-y: auto;
    }

    .tab-content.active {
        display: block;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 10px;
    }

    .field {
        display: flex;
        flex-direction: column;
    }

    .field label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 4px;
    }

    .field input, .field textarea {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 13px;
    }

    .field input:focus, .field textarea:focus {
        outline: none;
        border-color: #4ECDC4;
    }

    .presets {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
        margin: 8px 0;
    }

    .preset {
        padding: 5px 2px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        font-size: 0.65rem;
        font-weight: 600;
        cursor: pointer;
        text-align: center;
    }

    .preset.active {
        background: #4ECDC4;
        color: white;
        border-color: #4ECDC4;
    }

    .btn {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 6px;
        transition: all 0.3s;
    }

    .btn-primary { background: #4ECDC4; color: white; }
    .btn-warning { background: #ffc107; color: white; }
    .btn-danger { background: #dc3545; color: white; }

    .btn:hover {
        transform: translateY(-1px);
    }

    .result {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 12px;
    line-height: 1.4;
    white-space: pre-wrap;
    max-height: 280px;
    overflow-y: auto;
    margin-bottom: 8px;
}

    .alert {
        padding: 6px 10px;
        margin: 6px 0;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-align: center;
    }

    .alert-success { background: #d4edda; color: #155724; }
    .alert-warning { background: #fff3cd; color: #856404; }
    .alert-danger { background: #f8d7da; color: #721c24; }
    .alert-info { background: #d1ecf1; color: #0c5460; }

    .actions {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 4px;
        margin-top: 8px;
    }

    .actions .btn {
        margin-bottom: 0;
        padding: 6px 2px;
        font-size: 0.65rem;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 Trading Calc</h1>
            <p>Compacta para escritorio</p>
        </div>

    <div class="status">
        <div class="status-box">
            <div class="status-label">Usado</div>
            <div class="status-value" id="usado">$0</div>
        </div>
        <div class="status-box">
            <div class="status-label">Disponible</div>
            <div class="status-value" id="disponible">$0</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('config')">⚙️</button>
        <button class="tab" onclick="showTab('add')">➕</button>
        <button class="tab" onclick="showTab('scale')">🔄</button>
        <button class="tab" onclick="showTab('parse')">📋</button>
        <button class="tab" onclick="showTab('result')">📊</button>
    </div>

    <!-- CONFIG TAB -->
    <div id="config" class="tab-content active">
        <div class="form-grid">
            <div class="field">
                <label>🪙 Símbolo</label>
                <input type="text" id="simbolo" placeholder="BTC, ETH...">
            </div>
            <div class="field">
                <label>💰 Riesgo Total</label>
                <input type="number" id="riesgo">
            </div>
        </div>

        <div class="form-grid">
            <div class="field">
                <label>📈 Tipo</label>
                <select id="tipo">
                    <option value="LONG">LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
            </div>
            <div class="field">
                <label>🔢 Lotes</label>
                <input type="number" id="lotes" step="0.001">
            </div>
        </div>

        <div class="form-grid">
            <div class="field">
                <label>📈 Promedio</label>
                <input type="number" id="promedio">
            </div>
            <div class="field">
                <label>📊 Actual</label>
                <input type="number" id="actual">
            </div>
        </div>

        <div class="form-grid">
            <div class="field">
                <label>🛡️ Stop</label>
                <input type="number" id="stop">
            </div>
            <div class="field">
                <label></label>
                <div></div>
            </div>
        </div>

        <button class="btn btn-primary" onclick="actualizarStatus()">📊 Update</button>
        <button class="btn btn-danger" onclick="resetearTodo()">🔄 Reset</button>
    </div>

    <!-- ADD TAB -->
    <div id="add" class="tab-content">
        <div class="form-grid">
            <div class="field">
                <label>📈 Precio</label>
                <input type="number" id="precio_entrada">
            </div>
            <div class="field">
                <label>💰 Dinero</label>
                <input type="number" id="dinero_agregar">
            </div>
        </div>

        <div class="presets">
            <button class="preset" onclick="presetAgregar(10)">$10</button>
            <button class="preset" onclick="presetAgregar(25)">$25</button>
            <button class="preset" onclick="presetAgregar(50)">$50</button>
            <button class="preset" onclick="presetAgregar('todo')">All</button>
        </div>

        <button class="btn btn-primary" onclick="calcularAgregar()">➕ Calc</button>
    </div>

    <!-- SCALE TAB -->
    <div id="scale" class="tab-content">
        <div class="form-grid">
            <div class="field">
                <label>📈 Desde</label>
                <input type="number" id="desde">
            </div>
            <div class="field">
                <label>📉 Hasta</label>
                <input type="number" id="hasta">
            </div>
        </div>

        <div class="form-grid">
            <div class="field">
                <label>🔢 Orders</label>
                <input type="number" id="ordenes">
            </div>
            <div class="field">
                <label>💰 Money</label>
                <input type="number" id="dinero_escalada">
            </div>
        </div>

        <div class="presets">
            <button class="preset" onclick="presetEscalada(25)">25%</button>
            <button class="preset" onclick="presetEscalada(50)">50%</button>
            <button class="preset" onclick="presetEscalada(75)">75%</button>
            <button class="preset" onclick="presetEscalada(100)">All</button>
        </div>

        <button class="btn btn-warning" onclick="calcularEscalada()">🧮 Calc</button>
    </div>

    <!-- PARSE TAB -->
    <div id="parse" class="tab-content">
        <div class="field">
            <label>📋 Pegar señal</label>
            <textarea id="parse_input" style="width:100%; height:80px; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; resize:none;" placeholder="BTC entrada 61000 30% escalada 59500 a 58500 con 20 ordenes 50% stop 58000"></textarea>
        </div>
        
        <button class="btn btn-primary" onclick="parsearSenal()">🔄 Cargar</button>
    </div>

    <!-- RESULT TAB -->
    <div id="result" class="tab-content">
        <div class="result" id="resultado">
💡 Setup data and calculate…
</div>

        <div class="actions">
            <button class="btn btn-primary" onclick="copiar()">📋 Copy</button>
            <button class="btn btn-warning" onclick="enviarTelegram()">📤 Bot</button>
            <button class="btn btn-danger" onclick="resetearTodo()">🔄 Reset</button>
        </div>
        
        <button class="btn btn-primary" onclick="calcularCombinado()" style="margin-top:8px;">🔥 Combined</button>
    </div>

    <div id="alertas"></div>
</div>

<script>
    var riesgoTotal = 0;
    var riesgoUsado = 0;
    var riesgoDisponible = 0;

    function showTab(tabName) {
        var contents = document.querySelectorAll('.tab-content');
        for (var i = 0; i < contents.length; i++) {
            contents[i].classList.remove('active');
        }
        
        var tabs = document.querySelectorAll('.tab');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }
        
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    function actualizarStatus() {
        var riesgo = parseFloat(document.getElementById('riesgo').value) || 0;
        var lotes = parseFloat(document.getElementById('lotes').value) || 0;
        var promedio = parseFloat(document.getElementById('promedio').value) || 0;
        var stop = parseFloat(document.getElementById('stop').value) || 0;

        if (riesgo <= 0) {
            alerta('warning', '⚠️ Set total risk');
            return;
        }

        riesgoTotal = riesgo;

        if (lotes > 0 && promedio > 0 && stop > 0) {
            riesgoUsado = lotes * Math.abs(promedio - stop);
        } else {
            riesgoUsado = 0;
        }

        riesgoDisponible = riesgoTotal - riesgoUsado;

        document.getElementById('usado').textContent = '$' + riesgoUsado.toFixed(0);
        document.getElementById('disponible').textContent = '$' + riesgoDisponible.toFixed(0);

        if (riesgoDisponible < 0) {
            alerta('danger', '🚨 Risk exceeded');
        } else if (riesgoDisponible === 0) {
            alerta('warning', '⚠️ No risk available');
        } else {
            alerta('success', '✅ $' + riesgoDisponible.toFixed(0) + ' available');
        }
    }

    function presetAgregar(valor) {
        limpiarPresets();
        event.target.classList.add('active');
        
        if (valor === 'todo') {
            // Restar $1 de seguridad
            document.getElementById('dinero_agregar').value = Math.max(0, riesgoDisponible - 1).toFixed(0);
        } else {
            document.getElementById('dinero_agregar').value = valor;
        }
    }

    function presetEscalada(porcentaje) {
        limpiarPresets();
        event.target.classList.add('active');
        
        // Restar $1 de seguridad para evitar errores de redondeo
        var dinero = Math.max(0, (riesgoDisponible * porcentaje / 100) - 1).toFixed(0);
        document.getElementById('dinero_escalada').value = dinero;
    }

    function calcularEscalada() {
    var simbolo = document.getElementById('simbolo').value || 'CRYPTO';
    var stop = parseFloat(document.getElementById('stop').value);
    var desde = parseFloat(document.getElementById('desde').value);
    var hasta = parseFloat(document.getElementById('hasta').value);
    var numOrdenes = parseInt(document.getElementById('ordenes').value);
    var dinero = parseFloat(document.getElementById('dinero_escalada').value);

    var lotesActuales = parseFloat(document.getElementById('lotes').value) || 0;
    var promedioActual = parseFloat(document.getElementById('promedio').value) || 0;

    if (!stop || !desde || !hasta || !numOrdenes || !dinero) {
        alerta('danger', '❌ Completa los campos');
        return;
    }

    if (dinero > riesgoDisponible) {
        alerta('danger', '❌ Solo $' + riesgoDisponible.toFixed(0) + ' disponible');
        return;
    }

    var promedioEscalada = (desde + hasta) / 2;
    var distancia = Math.abs(promedioEscalada - stop);
    var lotesEscalada = dinero / distancia;
    var lotesPorOrden = lotesEscalada / numOrdenes;
    var espaciado = Math.abs(hasta - desde) / (numOrdenes - 1);

    var lotesTotalesFinal = lotesActuales + lotesEscalada;
    var promedioFinal;
    
    if (lotesActuales > 0 && promedioActual > 0) {
        var valorActual = lotesActuales * promedioActual;
        var valorEscalada = lotesEscalada * promedioEscalada;
        promedioFinal = (valorActual + valorEscalada) / lotesTotalesFinal;
    } else {
        promedioFinal = promedioEscalada;
    }

    var resultado = '🔄 NUEVA ESCALADA\n\n';
    resultado += '🪙 ' + simbolo.toUpperCase() + '\n';
    resultado += 'Tipo: ' + document.getElementById('tipo').value + '\n\n';
    
    if (lotesActuales > 0) {
        resultado += '📊 POSICIÓN ACTUAL:\n';
        resultado += lotesActuales.toFixed(6) + ' lotes @ $' + promedioActual.toFixed(2) + '\n\n';
    }
    
    resultado += '🔄 ESCALADA:\n';
    resultado += '$' + desde + ' → $' + hasta + '\n';
    resultado += 'Órdenes: ' + numOrdenes + '\n';
    resultado += 'Dinero: $' + dinero.toFixed(0) + '\n';
    resultado += 'Lotes escalada: ' + lotesEscalada.toFixed(6) + '\n';
    resultado += 'Por orden: ' + lotesPorOrden.toFixed(6) + '\n\n';
    
    resultado += '🎯 POSICIÓN FINAL:\n';
    resultado += 'Total lotes: ' + lotesTotalesFinal.toFixed(6) + '\n';
    resultado += '🔼 Promedio Final: $' + promedioFinal.toFixed(2) + '\n';
    resultado += 'Stop: $' + stop + '\n\n';
    
    resultado += '📋 DETALLES:\n';
    resultado += 'Promedio escalada: $' + promedioEscalada.toFixed(2) + '\n';
    resultado += 'Espaciado: $' + espaciado.toFixed(2) + '\n';
    resultado += 'Restante: $' + (riesgoDisponible - dinero).toFixed(0);

    if (numOrdenes <= 8) {
        resultado += '\n\n📋 ÓRDENES:\n';
        for (var i = 0; i < numOrdenes; i++) {
            var precio = desde > hasta ? desde - (espaciado * i) : desde + (espaciado * i);
            resultado += (i+1) + '. $' + precio.toFixed(2) + ' → ' + lotesPorOrden.toFixed(6) + '\n';
        }
    }

    document.getElementById('resultado').textContent = resultado;
    showTab('result');
    alerta('success', '✅ Calculado');
}

    function calcularCombinado() {
        var simbolo = document.getElementById('simbolo').value || 'CRYPTO';
        var tipo = document.getElementById('tipo').value;
        var lotesActuales = parseFloat(document.getElementById('lotes').value) || 0;
        var promedioActual = parseFloat(document.getElementById('promedio').value) || 0;
        var stop = parseFloat(document.getElementById('stop').value);

        if (!stop) {
            alerta('danger', '❌ Set stop loss first');
            return;
        }

        var precioEntrada = parseFloat(document.getElementById('precio_entrada').value);
        var dineroAgregar = parseFloat(document.getElementById('dinero_agregar').value);
        var desde = parseFloat(document.getElementById('desde').value);
        var hasta = parseFloat(document.getElementById('hasta').value);
        var numOrdenes = parseInt(document.getElementById('ordenes').value);
        var dineroEscalada = parseFloat(document.getElementById('dinero_escalada').value);

        var tieneAdd = precioEntrada && dineroAgregar;
        var tieneScale = desde && hasta && numOrdenes && dineroEscalada;

        if (!tieneAdd && !tieneScale) {
            alerta('warning', '⚠️ Set add or scale data');
            return;
        }

        var totalDinero = 0;
        var totalLotes = lotesActuales;
        var valorTotal = lotesActuales * promedioActual;

        // Formato compatible con el bot
        var resultado = '📊 NUEVA ORDEN CALCULADA\n\n';
        resultado += '🔹 ' + simbolo.toLowerCase() + '\n\n';
        resultado += 'Tipo: ' + tipo + '\n';
        resultado += 'Riesgo: $' + riesgoTotal.toFixed(0) + '\n\n';
        resultado += 'Entradas:\n';

        // Entrada normal si existe
        if (tieneAdd) {
            var distanciaAdd = Math.abs(precioEntrada - stop);
            var lotesAdd = dineroAgregar / distanciaAdd;
            var pctAdd = (dineroAgregar / riesgoTotal * 100);
            totalLotes += lotesAdd;
            totalDinero += dineroAgregar;
            valorTotal += lotesAdd * precioEntrada;

            resultado += '- ' + precioEntrada.toFixed(0) + ' (' + pctAdd.toFixed(0) + '%) → ' + lotesAdd.toFixed(6) + ' lotes\n';
        }

        // Escalada si existe
        if (tieneScale) {
            var promedioScale = (desde + hasta) / 2;
            var distanciaScale = Math.abs(promedioScale - stop);
            var lotesScale = dineroEscalada / distanciaScale;
            var pctScale = (dineroEscalada / riesgoTotal * 100);
            totalLotes += lotesScale;
            totalDinero += dineroEscalada;
            valorTotal += lotesScale * promedioScale;

            resultado += '- Escalonada (' + pctScale.toFixed(0) + '%): ' + desde.toFixed(0) + ' a ' + hasta.toFixed(0) + ' con ' + numOrdenes + ' órdenes → ' + lotesScale.toFixed(6) + ' lotes\n';
        }

        var promedioFinal = valorTotal / totalLotes;
        var perdidaSL = Math.abs(stop - promedioFinal) * totalLotes;

        resultado += '\nPrecio Promedio: ' + promedioFinal.toFixed(2) + '\n';
        resultado += 'SL: ' + stop.toFixed(0) + ' (Pérdida: ' + perdidaSL.toFixed(2) + ')\n\n';
        resultado += 'Lotes Totales: ' + totalLotes.toFixed(6) + '\n\n';

        // Verificar si el riesgo está exacto
        if (Math.abs(perdidaSL - totalDinero) < 1) {
            resultado += '✅ RIESGO EXACTO';
        } else {
            var pctTotal = (totalDinero / riesgoTotal * 100);
            resultado += '⚠️ PORCENTAJES: ' + pctTotal.toFixed(0) + '% (debe ser 100%)';
        }

        document.getElementById('resultado').textContent = resultado;
        alerta('success', '✅ Combined calculated');
    }

    function parsearSenal() {
    var input = document.getElementById('parse_input').value.toLowerCase();
    if (!input.trim()) {
        alerta('warning', '⚠️ Pega la señal primero');
        return;
    }

    // Extraer símbolo
    var simboloMatch = input.match(/^([a-z]{2,5})/i);
    if (simboloMatch) {
        document.getElementById('simbolo').value = simboloMatch[1].toUpperCase();
    }

    // Extraer riesgo - múltiples formatos
    var riesgoMatch = input.match(/(?:riesgo|risk)[:\s]*\$?(\d+)/i) || 
                     input.match(/\$(\d+)/);
    if (riesgoMatch) {
        document.getElementById('riesgo').value = riesgoMatch[1];
    }

    // Extraer stop - múltiples formatos
    var stopMatch = input.match(/(?:stop|sl|stop\s*loss)[:\s]*\$?(\d+)/i);
    if (stopMatch) {
        document.getElementById('stop').value = stopMatch[1];
    }

    // Extraer tipo
    var tipoMatch = input.match(/(long|short)/i);
    if (tipoMatch) {
        document.getElementById('tipo').value = tipoMatch[1].toUpperCase();
    }

    // Extraer precio promedio - múltiples formatos
    var promedioMatch = input.match(/(?:precio\s*prom|precio\s*promedio|promedio)[:\s]*\$?(\d+)/i);
    if (promedioMatch) {
        document.getElementById('promedio').value = promedioMatch[1];
    }

    // Extraer actual
    var actualMatch = input.match(/(?:actual)[:\s]*\$?(\d+)/i);
    if (actualMatch) {
        document.getElementById('actual').value = actualMatch[1];
    }

    // Extraer lotes
    var lotesMatch = input.match(/(?:lotes)[:\s]*(\d+(?:\.\d+)?)/i);
    if (lotesMatch) {
        document.getElementById('lotes').value = lotesMatch[1];
    }

    // Extraer scale/escalada - formato: scale 108000-108500
    var scaleMatch = input.match(/(?:scale|escalada|escalonada)[:\s]*(\d+)[-–](\d+)/i);
    if (scaleMatch) {
        document.getElementById('desde').value = scaleMatch[1];
        document.getElementById('hasta').value = scaleMatch[2];
    }

    // Extraer entrada
    var entradaMatch = input.match(/(?:entrada|entry)[:\s]*\$?(\d+)\s*(\d+)%/i);
    if (entradaMatch) {
        document.getElementById('precio_entrada').value = entradaMatch[1];
        var riesgo = parseFloat(document.getElementById('riesgo').value) || 100;
        var dinero = (riesgo * parseInt(entradaMatch[2]) / 100).toFixed(0);
        document.getElementById('dinero_agregar').value = dinero;
    }

    // Extraer escalada completa - formato: escalada 59500 a 58500 con 20 ordenes 50%
    var escaladaMatch = input.match(/(?:escalada|scale|escalonada)[:\s]*\$?(\d+)\s*a\s*\$?(\d+)\s*con\s*(\d+)\s*(?:ordenes?|orders?)\s*(\d+)%/i);
    if (escaladaMatch) {
        document.getElementById('desde').value = escaladaMatch[1];
        document.getElementById('hasta').value = escaladaMatch[2];
        document.getElementById('ordenes').value = escaladaMatch[3];
        var riesgo = parseFloat(document.getElementById('riesgo').value) || 100;
        var dinero = (riesgo * parseInt(escaladaMatch[4]) / 100).toFixed(0);
        document.getElementById('dinero_escalada').value = dinero;
    }

    if (document.getElementById('riesgo').value) {
        actualizarStatus();
    }

    alerta('success', '✅ Señal cargada');
    showTab('config');
}

    function copiar() {
        var texto = document.getElementById('resultado').textContent;
        if (texto.includes('Setup data')) {
            alerta('warning', '⚠️ Calculate first');
            return;
        }
        
        navigator.clipboard.writeText(texto).then(function() {
            alerta('success', '✅ Copied');
        }).catch(function() {
            alerta('danger', '❌ Copy error');
        });
    }

    function enviarTelegram() {
    var texto = document.getElementById('resultado').textContent;
    if (texto.includes('Setup data')) {
        alerta('warning', '⚠️ Calculate first');
        return;
    }

    // Convertir al formato del bot
    var textoBot = convertirFormatoBot(texto);
    
    var botToken = "7582987755:AAFBdNQFZ4McMsJwt60gvTs9CW2XkKZ3OMA";
    var chatId = "7471012566";
    var url = 'https://api.telegram.org/bot' + botToken + '/sendMessage';
    
    alerta('info', '📤 Enviando a Telegram...');
    
    fetch(url, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            chat_id: chatId, 
            text: textoBot
        })
    })
    .then(function(response) { 
        return response.json(); 
    })
    .then(function(data) {
        if (data.ok) {
            alerta('success', '✅ Enviado a Telegram');
        } else {
            alerta('danger', '❌ Error: ' + (data.description || 'Error desconocido'));
        }
    })
    .catch(function(error) {
        alerta('danger', '❌ Error de conexión');
        console.error('Error:', error);
    });
}

function convertirFormatoBot(texto) {
    var simbolo = document.getElementById('simbolo').value || 'crypto';
    var tipo = document.getElementById('tipo').value;
    var riesgo = riesgoTotal;
    
    // Resultado base - FORMATO EXACTO
    var resultado = '📊 NUEVA ORDEN CALCULADA\n\n';
    resultado += '🔹 ' + simbolo.toLowerCase() + '\n\n';
    resultado += 'Tipo: ' + tipo + '\n';
    resultado += 'Riesgo: $' + riesgo + '\n\n';
    resultado += 'Entradas:\n';
    
    // Detectar tipo de cálculo
    if (texto.includes('➕ AGREGAR A POSICIÓN')) {
        // Entrada simple
        var precioMatch = texto.match(/Precio: \$(\d+(?:\.\d+)?)/);
        var dineroMatch = texto.match(/Dinero: \$(\d+)/);
        var lotesMatch = texto.match(/Lotes: (\d+\.\d+)/);
        
        if (precioMatch && dineroMatch && lotesMatch) {
            var precio = parseFloat(precioMatch[1]);
            var dinero = parseFloat(dineroMatch[1]);
            var lotes = parseFloat(lotesMatch[1]);
            var pct = (dinero / riesgo * 100);
            
            resultado += '- ' + precio + ' (' + pct.toFixed(0) + '%) → ' + lotes.toFixed(6) + ' lotes\n';
        }
        
    } else if (texto.includes('🔄 NUEVA ESCALADA')) {
        // Escalada
        var rangoMatch = texto.match(/\$(\d+) → \$(\d+)/);
        var ordenesMatch = texto.match(/Órdenes: (\d+)/);
        var dineroMatch = texto.match(/Dinero: \$(\d+)/);
        var scaleLotesMatch = texto.match(/Lotes escalada: (\d+\.\d+)/);
        
        if (rangoMatch && ordenesMatch && dineroMatch && scaleLotesMatch) {
            var desde = parseFloat(rangoMatch[1]);
            var hasta = parseFloat(rangoMatch[2]);
            var ordenes = parseInt(ordenesMatch[1]);
            var dinero = parseFloat(dineroMatch[1]);
            var scaleLotes = parseFloat(scaleLotesMatch[1]);
            var pct = (dinero / riesgo * 100);
            
            resultado += '- Escalonada (' + pct.toFixed(0) + '%): ' + desde + ' a ' + hasta + ' con ' + ordenes + ' órdenes → ' + scaleLotes.toFixed(6) + ' lotes\n';
        }
        
    } else if (texto.includes('📊 NUEVA ORDEN CALCULADA')) {
        // Combinado - extraer entradas del texto original
        var entradasMatch = texto.match(/Entradas:\n([\s\S]*?)\n\nPrecio Promedio/);
        if (entradasMatch) {
            resultado += entradasMatch[1] + '\n';
        }
    }
    
    // Extraer datos finales
    var promedioMatch = texto.match(/(?:🔼 Promedio|🔼 Promedio Final|Precio Promedio): \$?(\d+(?:\.\d+)?)/);
    var stopMatch = texto.match(/Stop: \$?(\d+)/);
    var totalLotesMatch = texto.match(/(?:Total|Total lotes|Lotes Totales): (\d+\.\d+)/);
    
    var promedio = promedioMatch ? parseFloat(promedioMatch[1]) : 0;
    var stop = stopMatch ? parseFloat(stopMatch[1]) : 0;
    var totalLotes = totalLotesMatch ? parseFloat(totalLotesMatch[1]) : 0;
    
    var perdida = Math.abs(stop - promedio) * totalLotes;
    
    // FORMATO EXACTO COMO TU CALCULADORA QUE FUNCIONA - SIN TP AUTOMÁTICO
    resultado += '\nPrecio Promedio: ' + promedio.toFixed(2) + '\n';
    resultado += 'SL: ' + stop + ' (Pérdida: ' + perdida.toFixed(2) + ')\n\n';
    resultado += 'Lotes Totales: ' + totalLotes.toFixed(6) + '\n\n';
    resultado += '✅ RIESGO EXACTO';
    
    return resultado;
}

function resetearTodo() {
    var campos = ['simbolo', 'riesgo', 'lotes', 'promedio', 'actual', 'stop', 'precio_entrada', 'dinero_agregar', 'desde', 'hasta', 'ordenes', 'dinero_escalada'];
    
    for (var i = 0; i < campos.length; i++) {
        var campo = document.getElementById(campos[i]);
        if (campo) campo.value = '';
    }

    document.getElementById('tipo').value = 'LONG';
    var parseInput = document.getElementById('parse_input');
    if (parseInput) parseInput.value = '';

    limpiarPresets();
    riesgoTotal = 0;
    riesgoUsado = 0;
    riesgoDisponible = 0;

    document.getElementById('usado').textContent = '$0';
    document.getElementById('disponible').textContent = '$0';
    document.getElementById('resultado').textContent = '💡 Configura datos y calcula...';
    document.getElementById('alertas').innerHTML = '';

    alerta('success', '✅ Reset completo');
}

    function limpiarPresets() {
        var presets = document.querySelectorAll('.preset');
        for (var i = 0; i < presets.length; i++) {
            presets[i].classList.remove('active');
        }
    }

    function calcularAgregar() {
        var simbolo = document.getElementById('simbolo').value || 'CRYPTO';
        var lotesActuales = parseFloat(document.getElementById('lotes').value) || 0;
        var promedioActual = parseFloat(document.getElementById('promedio').value) || 0;
        var stop = parseFloat(document.getElementById('stop').value);
        var precioEntrada = parseFloat(document.getElementById('precio_entrada').value);
        var dinero = parseFloat(document.getElementById('dinero_agregar').value);

        if (!stop || !precioEntrada || !dinero) {
            alerta('danger', '❌ Completa los campos');
            return;
        }

        if (dinero > riesgoDisponible) {
            alerta('danger', '❌ Solo $' + riesgoDisponible.toFixed(0) + ' disponible');
            return;
        }

        var distancia = Math.abs(precioEntrada - stop);
        var lotesAgregar = dinero / distancia;
        var lotesNuevos = lotesActuales + lotesAgregar;

        var promedioNuevo;
        if (lotesActuales > 0 && promedioActual > 0) {
            promedioNuevo = ((lotesActuales * promedioActual) + (lotesAgregar * precioEntrada)) / lotesNuevos;
        } else {
            promedioNuevo = precioEntrada;
        }

        var resultado = '➕ AGREGAR A POSICIÓN\n\n';
        resultado += '🪙 ' + simbolo.toUpperCase() + '\n';
        resultado += 'Tipo: ' + document.getElementById('tipo').value + '\n\n';
        resultado += '📊 ACTUAL:\n';
        resultado += lotesActuales.toFixed(6) + ' lotes @ $' + promedioActual.toFixed(2) + '\n\n';
        resultado += '➕ AGREGAR:\n';
        resultado += 'Precio: $' + precioEntrada.toFixed(2) + '\n';
        resultado += 'Dinero: $' + dinero.toFixed(0) + '\n';
        resultado += 'Lotes: ' + lotesAgregar.toFixed(6) + '\n\n';
        resultado += '🎯 RESULTADO:\n';
        resultado += 'Total: ' + lotesNuevos.toFixed(6) + ' lotes\n';
        resultado += '🔼 Promedio: $' + promedioNuevo.toFixed(2) + '\n';
        resultado += 'Stop: $' + stop + '\n\n';
        resultado += '✅ ORDEN:\n';
        resultado += 'COMPRAR ' + lotesAgregar.toFixed(6) + ' @ $' + precioEntrada.toFixed(2);

        document.getElementById('resultado').textContent = resultado;
        showTab('result');
        alerta('success', '✅ Calculado');
    }

    function alerta(tipo, mensaje) {
        document.getElementById('alertas').innerHTML = '<div class="alert alert-' + tipo + '">' + mensaje + '</div>';
        setTimeout(function() {
            document.getElementById('alertas').innerHTML = '';
        }, 3000);
    }

    // Auto-update
    document.addEventListener('DOMContentLoaded', function() {
        var camposAuto = ['riesgo', 'lotes', 'promedio', 'stop'];
        
        for (var i = 0; i < camposAuto.length; i++) {
            var campo = document.getElementById(camposAuto[i]);
            if (campo) {
                campo.addEventListener('input', function() {
                    var self = this;
                    clearTimeout(self.updateTimeout);
                    self.updateTimeout = setTimeout(function() {
                        actualizarStatus();
                    }, 500);
                });
                
                campo.addEventListener('blur', actualizarStatus);
            }
        }
    });
</script>
</body>
</html>
