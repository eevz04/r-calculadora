<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Trading Calculator - Optimized</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
        }

        .container {
            width: 350px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            position: sticky;
            top: 15px;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
        }

        .status-box {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .status-label {
            color: #666;
            font-weight: 600;
            font-size: 0.65rem;
        }

        .status-value {
            font-weight: 700;
            color: #333;
            margin-top: 2px;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
        }

        .tab {
            flex: 1;
            padding: 10px 4px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 0.65rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #4ECDC4;
        }

        .tab-content {
            display: none;
            padding: 12px;
            min-height: 350px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .field {
            display: flex;
            flex-direction: column;
        }

        .field label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
        }

        .field input, .field textarea, .field select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }

        .field input:focus, .field textarea:focus, .field select:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            margin: 8px 0;
        }

        .preset {
            padding: 5px 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .preset:hover {
            background: #f8f9fa;
        }

        .preset.active {
            background: #4ECDC4;
            color: white;
            border-color: #4ECDC4;
        }

        .btn {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 6px;
            transition: all 0.3s;
        }

        .btn-primary { background: #4ECDC4; color: white; }
        .btn-warning { background: #ffc107; color: white; }
        .btn-danger { background: #dc3545; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 280px;
            overflow-y: auto;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }

        .alert {
            padding: 6px 10px;
            margin: 6px 0;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            margin-top: 8px;
        }

        .actions .btn {
            margin-bottom: 0;
            padding: 6px 2px;
            font-size: 0.65rem;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4ECDC4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Trading Calc</h1>
            <p>Optimizado v2.0</p>
        </div>

        <div class="status">
            <div class="status-box">
                <div class="status-label">Usado</div>
                <div class="status-value" id="usado">$0</div>
            </div>
            <div class="status-box">
                <div class="status-label">Disponible</div>
                <div class="status-value" id="disponible">$0</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('config')">‚öôÔ∏è</button>
            <button class="tab" onclick="showTab('add')">‚ûï</button>
            <button class="tab" onclick="showTab('scale')">üîÑ</button>
            <button class="tab" onclick="showTab('parse')">üìã</button>
            <button class="tab" onclick="showTab('result')">üìä</button>
        </div>

        <!-- CONFIG TAB -->
        <div id="config" class="tab-content active">
            <div class="form-grid">
                <div class="field">
                    <label>ü™ô S√≠mbolo</label>
                    <input type="text" id="simbolo" placeholder="BTC, ETH...">
                </div>
                <div class="field">
                    <label>üí∞ Riesgo Total</label>
                    <input type="number" id="riesgo" step="0.01">
                </div>
            </div>

            <div class="form-grid">
                <div class="field">
                    <label>üìà Tipo</label>
                    <select id="tipo">
                        <option value="LONG">LONG</option>
                        <option value="SHORT">SHORT</option>
                    </select>
                </div>
                <div class="field">
                    <label>üî¢ Lotes</label>
                    <input type="number" id="lotes" step="0.001">
                </div>
            </div>

            <div class="form-grid">
                <div class="field">
                    <label>üìà Promedio</label>
                    <input type="number" id="promedio" step="0.01">
                </div>
                <div class="field">
                    <label>üìä Actual</label>
                    <input type="number" id="actual" step="0.01">
                </div>
            </div>

            <div class="form-grid">
                <div class="field">
                    <label>üõ°Ô∏è Stop</label>
                    <input type="number" id="stop" step="0.01">
                </div>
                <div class="field">
                    <label></label>
                    <div></div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="actualizarStatus()">üìä Update</button>
            <button class="btn btn-danger" onclick="resetearTodo()">üîÑ Reset</button>
        </div>

        <!-- ADD TAB -->
        <div id="add" class="tab-content">
            <div class="form-grid">
                <div class="field">
                    <label>üìà Precio</label>
                    <input type="number" id="precio_entrada" step="0.01">
                </div>
                <div class="field">
                    <label>üí∞ Dinero</label>
                    <input type="number" id="dinero_agregar" step="0.01">
                </div>
            </div>

            <div class="presets">
                <button class="preset" onclick="presetAgregar(25)">25%</button>
                <button class="preset" onclick="presetAgregar(50)">50%</button>
                <button class="preset" onclick="presetAgregar(75)">75%</button>
                <button class="preset" onclick="presetAgregar('todo')">All</button>
            </div>

            <button class="btn btn-primary" onclick="calcularAgregar()">‚ûï Calc</button>
        </div>

        <!-- SCALE TAB -->
        <div id="scale" class="tab-content">
            <div class="form-grid">
                <div class="field">
                    <label>üìà Desde</label>
                    <input type="number" id="desde" step="0.01">
                </div>
                <div class="field">
                    <label>üìâ Hasta</label>
                    <input type="number" id="hasta" step="0.01">
                </div>
            </div>

            <div class="form-grid">
                <div class="field">
                    <label>üî¢ Orders</label>
                    <input type="number" id="ordenes" min="2" max="20">
                </div>
                <div class="field">
                    <label>üí∞ Money</label>
                    <input type="number" id="dinero_escalada" step="0.01">
                </div>
            </div>

            <div class="presets">
                <button class="preset" onclick="presetEscalada(25)">25%</button>
                <button class="preset" onclick="presetEscalada(50)">50%</button>
                <button class="preset" onclick="presetEscalada(75)">75%</button>
                <button class="preset" onclick="presetEscalada(100)">All</button>
            </div>

            <button class="btn btn-warning" onclick="calcularEscalada()">üßÆ Calc</button>
        </div>

        <!-- PARSE TAB -->
        <div id="parse" class="tab-content">
            <div class="field">
                <label>üìã Pegar se√±al</label>
                <textarea id="parse_input" style="width:100%; height:80px; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; resize:none;" placeholder="BTC entrada 61000 30% escalada 59500 a 58500 con 20 ordenes 50% stop 58000"></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="parsearSenal()">üîÑ Cargar</button>
        </div>

        <!-- RESULT TAB -->
        <div id="result" class="tab-content">
            <div class="result" id="resultado">üí° Setup data and calculate‚Ä¶</div>

            <div class="actions">
                <button class="btn btn-primary" onclick="copiar()">üìã Copy</button>
                <button class="btn btn-warning" onclick="enviarTelegram()" id="btnTelegram">üì§ Bot</button>
                <button class="btn btn-danger" onclick="resetearTodo()">üîÑ Reset</button>
            </div>
            
            <button class="btn btn-primary" onclick="calcularCombinado()" style="margin-top:8px;">üî• Combined</button>
        </div>

        <div id="alertas"></div>
    </div>

    <script>
        // üß† FUNCI√ìN DE DISTRIBUCI√ìN INTELIGENTE PARA TODAS LAS CRYPTOS
        function distribuirCantidadesInteligente(totalLotes, numOrdenes, tipoOperacion) {
            let pesos;
            
            if (tipoOperacion === 'LONG') {
                // COMPRAS: M√°s lotes ABAJO (mejores precios)
                if (numOrdenes <= 5) {
                    pesos = [8, 12, 20, 30, 30];
                } else if (numOrdenes <= 10) {
                    pesos = [3, 4, 5, 7, 10, 15, 20, 16, 12, 8];
                } else if (numOrdenes <= 15) {
                    pesos = [2, 3, 4, 5, 6, 7, 8, 10, 12, 14, 16, 14, 12, 10, 7];
                } else if (numOrdenes <= 20) {
                    pesos = [1, 1, 2, 2, 3, 4, 5, 6, 8, 10, 12, 14, 12, 10, 8, 6, 5, 4, 3, 2];
                } else {
                    pesos = [];
                    for (let i = 0; i < numOrdenes; i++) {
                        const peso = 1 + (i * 2);
                        pesos.push(peso);
                    }
                }
            } else {
                // VENTAS/SHORTS: M√°s lotes ARRIBA (mejores precios)
                if (numOrdenes <= 5) {
                    pesos = [30, 30, 20, 12, 8];
                } else if (numOrdenes <= 10) {
                    pesos = [8, 12, 16, 20, 15, 10, 7, 5, 4, 3];
                } else if (numOrdenes <= 15) {
                    pesos = [7, 10, 12, 14, 16, 14, 12, 10, 8, 7, 6, 5, 4, 3, 2];
                } else if (numOrdenes <= 20) {
                    pesos = [2, 3, 4, 5, 6, 8, 10, 12, 14, 12, 10, 8, 6, 5, 4, 3, 2, 2, 1, 1];
                } else {
                    pesos = [];
                    for (let i = 0; i < numOrdenes; i++) {
                        const peso = numOrdenes - i;
                        pesos.push(peso);
                    }
                }
            }
            
            if (pesos.length !== numOrdenes) {
                const ratio = numOrdenes / pesos.length;
                const nuevoPesos = [];
                for (let i = 0; i < numOrdenes; i++) {
                    const index = Math.floor(i / ratio);
                    nuevoPesos.push(pesos[Math.min(index, pesos.length - 1)]);
                }
                pesos = nuevoPesos;
            }
            
            const totalPeso = pesos.reduce((sum, peso) => sum + peso, 0);
            const porcentajes = pesos.map(peso => peso / totalPeso);
            const cantidades = porcentajes.map(pct => totalLotes * pct);
            
            return cantidades;
        }

        // Variables globales
        let riesgoTotal = 0;
        let riesgoUsado = 0;
        let riesgoDisponible = 0;
        window.formatoParaBot = null;

        // Utilidades
        function formatNumber(num, decimales = 2) {
            if (isNaN(num)) return "0";
            return parseFloat(num).toFixed(decimales);
        }

        function validateNumber(value, min = 0) {
            const num = parseFloat(value);
            return !isNaN(num) && num >= min ? num : null;
        }

        // Navegaci√≥n de tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Actualizar status de riesgo
        function actualizarStatus() {
            const riesgo = validateNumber(document.getElementById('riesgo').value);
            const lotes = validateNumber(document.getElementById('lotes').value);
            const promedio = validateNumber(document.getElementById('promedio').value);
            const stop = validateNumber(document.getElementById('stop').value);

            if (!riesgo || riesgo <= 0) {
                alerta('warning', '‚ö†Ô∏è Set total risk');
                return;
            }

            riesgoTotal = riesgo;

            if (lotes && promedio && stop) {
                riesgoUsado = lotes * Math.abs(promedio - stop);
            } else {
                riesgoUsado = 0;
            }

            riesgoDisponible = riesgoTotal - riesgoUsado;

            document.getElementById('usado').textContent = '$' + formatNumber(riesgoUsado, 0);
            document.getElementById('disponible').textContent = '$' + formatNumber(riesgoDisponible, 0);

            if (riesgoDisponible < 0) {
                alerta('danger', 'üö® Risk exceeded');
            } else if (riesgoDisponible === 0) {
                alerta('warning', '‚ö†Ô∏è No risk available');
            } else {
                alerta('success', '‚úÖ $' + formatNumber(riesgoDisponible, 0) + ' available');
            }
        }

        // Presets para agregar dinero
        function presetAgregar(valor) {
            limpiarPresets();
            event.target.classList.add('active');
            
            if (valor === 'todo') {
                document.getElementById('dinero_agregar').value = formatNumber(Math.max(0, riesgoDisponible - 1), 0);
            } else if (typeof valor === 'number') {
                // Es un porcentaje
                const dinero = Math.max(0, (riesgoDisponible * valor / 100) - 1);
                document.getElementById('dinero_agregar').value = formatNumber(dinero, 0);
            } else {
                document.getElementById('dinero_agregar').value = valor;
            }
        }

        // Presets para escalada
        function presetEscalada(porcentaje) {
            limpiarPresets();
            event.target.classList.add('active');
            
            const dinero = Math.max(0, (riesgoDisponible * porcentaje / 100) - 1);
            document.getElementById('dinero_escalada').value = formatNumber(dinero, 0);
        }

        // Calcular agregar posici√≥n
        function calcularAgregar() {
            const simbolo = document.getElementById('simbolo').value || 'CRYPTO';
            const lotesActuales = validateNumber(document.getElementById('lotes').value) || 0;
            const promedioActual = validateNumber(document.getElementById('promedio').value) || 0;
            const stop = validateNumber(document.getElementById('stop').value);
            const precioEntrada = validateNumber(document.getElementById('precio_entrada').value);
            const dinero = validateNumber(document.getElementById('dinero_agregar').value);

            if (!stop || !precioEntrada || !dinero) {
                alerta('danger', '‚ùå Complete fields');
                return;
            }

            if (dinero > riesgoDisponible) {
                alerta('danger', '‚ùå Only $' + formatNumber(riesgoDisponible, 0) + ' available');
                return;
            }

            const distancia = Math.abs(precioEntrada - stop);
            const lotesAgregar = dinero / distancia;
            const lotesNuevos = lotesActuales + lotesAgregar;

            let promedioNuevo;
            if (lotesActuales > 0 && promedioActual > 0) {
                promedioNuevo = ((lotesActuales * promedioActual) + (lotesAgregar * precioEntrada)) / lotesNuevos;
            } else {
                promedioNuevo = precioEntrada;
            }

            const perdidaTotalReal = Math.abs(stop - promedioNuevo) * lotesNuevos;
            const riesgoExacto = Math.abs(perdidaTotalReal - riesgoTotal) < 1;

            // üéØ OPTIMIZAR DECIMALES SEG√öN S√çMBOLO
            const symbol = simbolo.toLowerCase();
            let lots, priceDecimals;

            // Configurar decimales por s√≠mbolo
            if (symbol === 'btc') {
                lots = lotesAgregar.toFixed(3);        // BTC: 0.026
                priceDecimals = 2;                     // Precio: 100580.72
            } else if (['eth', 'sol', 'bnb', 'avax', 'dot', 'link', 'uni'].includes(symbol)) {
                lots = lotesAgregar.toFixed(2);        // ETH: 0.50  
                priceDecimals = 2;                     // Precio: 3456.78
            } else if (['pepe', '1000pepe', 'shib', 'floki', '1000bonk', '1000sats'].includes(symbol)) {
                lots = Math.round(lotesAgregar).toString();  // PEPE: 50000
                priceDecimals = 6;                     // Precio: 0.000123
            } else if (['kaito', 'wif', 'popcat', 'moodeng'].includes(symbol)) {
                lots = lotesAgregar.toFixed(1);        // KAITO: 586.8
                priceDecimals = 4;                     // Precio: 1.4567
            } else {
                // Tokens generales
                lots = lotesAgregar.toFixed(3);        // General: 123.456
                priceDecimals = 4;                     // Precio: 12.3456
            }

           // Formatear precios con decimales apropiados
           const precioFormateado = precioEntrada.toFixed(priceDecimals);
           const stopFormateado = stop.toFixed(priceDecimals);

           // Formato nuevo tipo "üìä NUEVA ORDEN CALCULADA" para ADD
           const resultado = `üìä NUEVA ORDEN CALCULADA
üîπ ${simbolo.toLowerCase()}
Tipo: ${document.getElementById('tipo').value}
Riesgo: $${dinero.toFixed(0)}
Entradas:
- ${precioFormateado} ‚Üí ${lots} lotes
Precio Promedio: ${precioFormateado}
SL: ${stopFormateado} (P√©rdida: ${dinero.toFixed(2)})
Lotes Totales: ${lots}
‚úÖ RIESGO EXACTO`;

           document.getElementById('resultado').textContent = resultado;

           // Guardar formato bot con decimales correctos
           window.formatoParaBot = `BUY ${simbolo.toUpperCase()}USDT ${lots} ${precioFormateado} SL:${stopFormateado}`;
           
           showTab('result');
           alerta('success', '‚úÖ Calculated');
       }
       
       // Calcular escalada
        function calcularEscalada() {
            const simbolo = document.getElementById('simbolo').value || 'CRYPTO';
            const stop = validateNumber(document.getElementById('stop').value);
            const desde = validateNumber(document.getElementById('desde').value);
            const hasta = validateNumber(document.getElementById('hasta').value);
            const numOrdenes = parseInt(document.getElementById('ordenes').value);
            const dinero = validateNumber(document.getElementById('dinero_escalada').value);

            const lotesActuales = validateNumber(document.getElementById('lotes').value) || 0;
            const promedioActual = validateNumber(document.getElementById('promedio').value) || 0;

            if (!stop || !desde || !hasta || !numOrdenes || !dinero) {
                alerta('danger', '‚ùå Complete fields');
                return;
            }

            if (dinero > riesgoDisponible) {
                alerta('danger', '‚ùå Only $' + formatNumber(riesgoDisponible, 0) + ' available');
                return;
            }

            const promedioEscalada = (desde + hasta) / 2;
            const distancia = Math.abs(promedioEscalada - stop);
            const lotesEscalada = dinero / distancia;
            
            // üß† USAR DISTRIBUCI√ìN INTELIGENTE
            const tipo = document.getElementById('tipo').value;
            const cantidadesInteligentes = distribuirCantidadesInteligente(lotesEscalada, numOrdenes, tipo);
            
            const espaciado = Math.abs(hasta - desde) / (numOrdenes - 1);
            const lotesTotalesFinal = lotesActuales + lotesEscalada;
            let promedioFinal;
            
            if (lotesActuales > 0 && promedioActual > 0) {
                const valorActual = lotesActuales * promedioActual;
                const valorEscalada = lotesEscalada * promedioEscalada;
                promedioFinal = (valorActual + valorEscalada) / lotesTotalesFinal;
            } else {
                promedioFinal = promedioEscalada;
            }

            const perdidaTotalReal = Math.abs(stop - promedioFinal) * lotesTotalesFinal;
            const riesgoExacto = Math.abs(perdidaTotalReal - riesgoTotal) < 1;

            // üéØ OPTIMIZAR DECIMALES SEG√öN S√çMBOLO PARA ESCALADA
            const symbol = simbolo.toLowerCase();
            let priceDecimals;

            if (symbol === 'btc') {
                priceDecimals = 2;
            } else if (['eth', 'sol', 'bnb', 'avax', 'dot', 'link', 'uni'].includes(symbol)) {
                priceDecimals = 2;
            } else if (['pepe', '1000pepe', 'shib', 'floki', '1000bonk', '1000sats'].includes(symbol)) {
                priceDecimals = 6;
            } else if (['kaito', 'wif', 'popcat', 'moodeng'].includes(symbol)) {
                priceDecimals = 4;
            } else {
                priceDecimals = 4;
            }

            // Formatear precios con decimales apropiados
            const desdeFormateado = desde.toFixed(priceDecimals);
            const hastaFormateado = hasta.toFixed(priceDecimals);
            const stopFormateado = stop.toFixed(priceDecimals);
            const promedioFormateado = promedioFinal.toFixed(priceDecimals);

            let resultado = `üîÑ NUEVA ESCALADA

üìä POSICI√ìN ACTUAL:
${lotesActuales > 0 ? lotesActuales.toFixed(3) + ' lotes @ $' + promedioActual.toFixed(priceDecimals) : 'Sin posici√≥n'}

üîÑ NUEVA ESCALADA:
$${desdeFormateado} ‚Üí $${hastaFormateado} con ${numOrdenes} √≥rdenes
${lotesEscalada.toFixed(3)} lotes nuevos
Dinero usado: $${dinero.toFixed(0)}

üéØ POSICI√ìN FINAL TOTAL:
Total lotes: ${lotesTotalesFinal.toFixed(3)}
Precio promedio: $${promedioFormateado}
SL: $${stopFormateado}
P√©rdida total: $${perdidaTotalReal.toFixed(2)}${riesgoExacto ? ' ‚úÖ' : ' ‚ö†Ô∏è'}

Restante: $${formatNumber(riesgoDisponible - dinero, 0)}`;

            if (numOrdenes <= 8) {
                resultado += '\n\nüìã √ìRDENES DETALLADAS:\n';
                for (let i = 0; i < numOrdenes; i++) {
                    const precio = desde > hasta ? desde - (espaciado * i) : desde + (espaciado * i);
                    resultado += `${i+1}. $${precio.toFixed(priceDecimals)} ‚Üí ${cantidadesInteligentes[i].toFixed(6)}\n`;
                }
            }

            document.getElementById('resultado').textContent = resultado;
            
            // Guardar formato bot para escalada con decimales optimizados
            const lado = document.getElementById('tipo').value === 'LONG' ? 'BUY' : 'SELL';
            window.formatoParaBot = `SCALE ${simbolo.toUpperCase()}USDT ${lado} ${lotesEscalada.toFixed(6)} ${desdeFormateado}-${hastaFormateado} ${numOrdenes} SL:${stopFormateado}`;
            
            showTab('result');
            alerta('success', '‚úÖ Calculated');
        }

        // Calcular combinado mejorado
        function calcularCombinado() {
            const simbolo = document.getElementById('simbolo').value || 'CRYPTO';
            const tipo = document.getElementById('tipo').value;
            const lotesActuales = validateNumber(document.getElementById('lotes').value) || 0;
            const promedioActual = validateNumber(document.getElementById('promedio').value) || 0;
            const stop = validateNumber(document.getElementById('stop').value);

            if (!stop) {
                alerta('danger', '‚ùå Set stop loss first');
                return;
            }

            const precioEntrada = validateNumber(document.getElementById('precio_entrada').value);
            const dineroAgregar = validateNumber(document.getElementById('dinero_agregar').value);
            const desde = validateNumber(document.getElementById('desde').value);
            const hasta = validateNumber(document.getElementById('hasta').value);
            const numOrdenes = parseInt(document.getElementById('ordenes').value);
            const dineroEscalada = validateNumber(document.getElementById('dinero_escalada').value);

            const tieneAdd = precioEntrada && dineroAgregar;
            const tieneScale = desde && hasta && numOrdenes && dineroEscalada;

            if (!tieneAdd && !tieneScale) {
                alerta('warning', '‚ö†Ô∏è Set add or scale data');
                return;
            }

            let totalDineroOperacion = 0;
            let lotesAdd = 0, lotesScale = 0, promedioScale = 0;

            if (tieneAdd) {
                const distanciaAdd = Math.abs(precioEntrada - stop);
                lotesAdd = dineroAgregar / distanciaAdd;
                totalDineroOperacion += dineroAgregar;
            }

            if (tieneScale) {
                promedioScale = (desde + hasta) / 2;
                const distanciaScale = Math.abs(promedioScale - stop);
                lotesScale = dineroEscalada / distanciaScale;
                totalDineroOperacion += dineroEscalada;
            }

            const totalLotes = lotesActuales + lotesAdd + lotesScale;
            const valorTotal = (lotesActuales * promedioActual) + (lotesAdd * precioEntrada) + (lotesScale * promedioScale);
            const promedioFinal = valorTotal / totalLotes;
            const perdidaTotalReal = Math.abs(stop - promedioFinal) * totalLotes;
            const riesgoExacto = Math.abs(perdidaTotalReal - riesgoTotal) < 1;

            let resultado = `üî• ESTRATEGIA COMBINADA

üìä POSICI√ìN ACTUAL:
${lotesActuales > 0 ? lotesActuales.toFixed(3) + ' lotes @ $' + promedioActual.toFixed(4) : 'Sin posici√≥n'}
Disponible: $${formatNumber(riesgoDisponible, 0)}

`;

            if (tieneAdd) {
                resultado += `‚ûï ENTRADA DIRECTA:
$${precioEntrada.toFixed(4)} con $${dineroAgregar.toFixed(0)} ‚Üí ${lotesAdd.toFixed(3)} lotes

`;
            }

            if (tieneScale) {
                resultado += `üîÑ ESCALADA DEFENSIVA:
$${desde.toFixed(4)} a $${hasta.toFixed(4)} con ${numOrdenes} √≥rdenes
$${dineroEscalada.toFixed(0)} ‚Üí ${lotesScale.toFixed(3)} lotes

`;
            }

            resultado += `üéØ POSICI√ìN FINAL TOTAL:
Total lotes: ${totalLotes.toFixed(3)}
Precio promedio: $${promedioFinal.toFixed(4)}
SL: $${stop.toFixed(4)}
P√©rdida total: $${perdidaTotalReal.toFixed(2)}${riesgoExacto ? ' ‚úÖ' : ' ‚ö†Ô∏è'}

üí∞ DINERO:
Esta operaci√≥n: $${totalDineroOperacion.toFixed(0)}
Restante: $${formatNumber(riesgoDisponible - totalDineroOperacion, 0)}`;

            document.getElementById('resultado').textContent = resultado;

            // Crear formato bot para operaci√≥n combinada
            let formatoBot = 'üìä NUEVA ORDEN CALCULADA\n\n';
            formatoBot += `üîπ ${simbolo.toLowerCase()}\n\n`;
            formatoBot += `Tipo: ${tipo}\n`;
            formatoBot += `Riesgo: $${totalDineroOperacion.toFixed(0)}\n\n`;
            formatoBot += 'Entradas:\n';

            if (tieneAdd) {
                formatoBot += `- ${precioEntrada.toFixed(4)} ‚Üí ${lotesAdd.toFixed(6)} lotes\n`;
            }

            if (tieneScale) {
                formatoBot += `- Escalonada: ${desde.toFixed(4)} a ${hasta.toFixed(4)} con ${numOrdenes} √≥rdenes ‚Üí ${lotesScale.toFixed(6)} lotes\n`;
            }

            // Promedio y SL de SOLO la nueva operaci√≥n
            let promedioNuevaOp, lotesNuevaOp;
            
            if (tieneAdd && tieneScale) {
                lotesNuevaOp = lotesAdd + lotesScale;
                promedioNuevaOp = (lotesAdd * precioEntrada + lotesScale * promedioScale) / lotesNuevaOp;
            } else if (tieneAdd) {
                lotesNuevaOp = lotesAdd;
                promedioNuevaOp = precioEntrada;
            } else if (tieneScale) {
                lotesNuevaOp = lotesScale;
                promedioNuevaOp = promedioScale;
            }

            formatoBot += `\nPrecio Promedio: ${promedioNuevaOp.toFixed(4)}\n`;
            formatoBot += `SL: ${stop.toFixed(4)} (P√©rdida: ${totalDineroOperacion.toFixed(2)})\n\n`;
            formatoBot += `Lotes Totales: ${lotesNuevaOp.toFixed(6)}\n\n`;
            formatoBot += '‚úÖ RIESGO EXACTO';

            window.formatoParaBot = formatoBot;
            alerta('success', '‚úÖ Estrategia calculada - Formato dual listo');
        }

        // Parsear se√±al
        function parsearSenal() {
            const input = document.getElementById('parse_input').value.toLowerCase();
            if (!input.trim()) {
                alerta('warning', '‚ö†Ô∏è Paste signal first');
                return;
            }

            // Extraer s√≠mbolo
            const simboloMatch = input.match(/^([a-z]{2,5})/i);
            if (simboloMatch) {
                document.getElementById('simbolo').value = simboloMatch[1].toUpperCase();
            }

            // Extraer riesgo
            const riesgoMatch = input.match(/(\d+)\$?\s*riesgo/i) || input.match(/\$(\d+)/);
            if (riesgoMatch) {
                document.getElementById('riesgo').value = riesgoMatch[1];
            }

            // Extraer stop
            const stopMatch = input.match(/(?:stop|sl)[:\s]*(\d+)/i);
            if (stopMatch) {
                document.getElementById('stop').value = stopMatch[1];
            }

            // Extraer entrada
            const entradaMatch = input.match(/(?:entrada|entry)[:\s]*(\d+)\s*(\d+)%/i);
            if (entradaMatch) {
                document.getElementById('precio_entrada').value = entradaMatch[1];
                const riesgo = validateNumber(document.getElementById('riesgo').value) || 100;
                const dinero = formatNumber((riesgo * parseInt(entradaMatch[2]) / 100), 0);
                document.getElementById('dinero_agregar').value = dinero;
            }

            // Extraer escalada
            const escaladaMatch = input.match(/(?:escalada|scale)[:\s]*(\d+)\s*a\s*(\d+)\s*con\s*(\d+)\s*ordenes?\s*(\d+)%/i);
            if (escaladaMatch) {
                document.getElementById('desde').value = escaladaMatch[1];
                document.getElementById('hasta').value = escaladaMatch[2];
                document.getElementById('ordenes').value = escaladaMatch[3];
                const riesgo = validateNumber(document.getElementById('riesgo').value) || 100;
                const dinero = formatNumber((riesgo * parseInt(escaladaMatch[4]) / 100), 0);
                document.getElementById('dinero_escalada').value = dinero;
            }

            if (document.getElementById('riesgo').value) {
                actualizarStatus();
            }

            alerta('success', '‚úÖ Signal loaded');
            showTab('config');
        }

        // Copiar al portapapeles
        function copiar() {
            let texto;
            
            // Si hay formato bot guardado, dar opci√≥n
            if (window.formatoParaBot) {
                const useBot = confirm("¬øCopiar formato para bot?\nOK = Formato bot\nCancel = Formato pantalla");
                texto = useBot ? window.formatoParaBot : document.getElementById('resultado').textContent;
            } else {
                texto = document.getElementById('resultado').textContent;
            }
            
            if (texto.includes('Setup data')) {
                alerta('warning', '‚ö†Ô∏è Calculate first');
                return;
            }
            
            navigator.clipboard.writeText(texto).then(function() {
                alerta('success', '‚úÖ Copied to clipboard');
            }).catch(function() {
                // M√©todo alternativo para navegadores antiguos
                const textArea = document.createElement('textarea');
                textArea.value = texto;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alerta('success', '‚úÖ Copied to clipboard');
            });
        }

        // Funci√≥n mejorada para enviar a Telegram
        async function enviarTelegram() {
            let textoBot;
            
            // Si hay formato guardado para bot, usarlo
            if (window.formatoParaBot) {
                textoBot = window.formatoParaBot;
                alerta('info', 'üì§ Enviando formato optimizado para bot...');
            } else {
                // Usar texto de pantalla como fallback
                textoBot = document.getElementById('resultado').textContent;
                if (textoBot.includes('Setup data')) {
                    alerta('warning', '‚ö†Ô∏è Calculate first');
                    return;
                }
                alerta('info', 'üì§ Enviando formato de pantalla...');
            }

            const btn = document.getElementById('btnTelegram');
            const originalText = btn.innerHTML;
            
            // Mostrar loading
            btn.innerHTML = '<span class="loading"></span>Sending...';
            btn.disabled = true;
            
            try {
                const botToken = "7582987755:AAFBdNQFZ4McMsJwt60gvTs9CW2XkKZ3OMA";
                const chatId = "7471012566";
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: textoBot
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    alerta('success', '‚úÖ Enviado a Telegram correctamente');
                    // Limpiar formato guardado despu√©s de env√≠o exitoso
                    window.formatoParaBot = null;
                } else {
                    throw new Error(data.description || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error:', error);
                
                // M√©todo alternativo: Copiar y mostrar instrucci√≥n
                try {
                    await navigator.clipboard.writeText(textoBot);
                    alerta('warning', '‚ö†Ô∏è Copiado al portapapeles - Env√≠a manualmente al bot');
                } catch (copyError) {
                    // Si ni siquiera puede copiar, abrir Telegram Web
                    const telegramWebUrl = `https://t.me/share/url?url=${encodeURIComponent('Trading Calculator:')}&text=${encodeURIComponent(textoBot)}`;
                    window.open(telegramWebUrl, '_blank');
                    alerta('info', 'üì± Telegram Web abierto - Env√≠a manualmente');
                }
            } finally {
                // Restaurar bot√≥n
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Resetear todo
        function resetearTodo() {
            const campos = ['simbolo', 'riesgo', 'lotes', 'promedio', 'stop', 
                           'precio_entrada', 'dinero_agregar', 'desde', 'hasta', 
                           'ordenes', 'dinero_escalada'];
            
            campos.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) elemento.value = '';
            });

            // Resetear select a LONG
            document.getElementById('tipo').value = 'LONG';

            // Limpiar textarea
            const parseInput = document.getElementById('parse_input');
            if (parseInput) parseInput.value = '';

            limpiarPresets();
            
            // Resetear variables globales
            riesgoTotal = 0;
            riesgoUsado = 0;
            riesgoDisponible = 0;

            document.getElementById('usado').textContent = '$0';
            document.getElementById('disponible').textContent = '$0';
            document.getElementById('resultado').textContent = 'üí° Setup data and calculate...';
            document.getElementById('alertas').innerHTML = '';

            // Limpiar formato bot guardado
            window.formatoParaBot = null;

            alerta('success', '‚úÖ Reset complete');
        }

        // Limpiar presets activos
        function limpiarPresets() {
            document.querySelectorAll('.preset').forEach(preset => {
                preset.classList.remove('active');
            });
        }

        // Sistema de alertas mejorado
        function alerta(tipo, mensaje) {
            const alertasContainer = document.getElementById('alertas');
            
            // Limpiar alertas anteriores
            alertasContainer.innerHTML = '';
            
            // Crear nueva alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.textContent = mensaje;
            
            alertasContainer.appendChild(alertDiv);
            
            // Auto-remove despu√©s de 4 segundos (excepto errores)
            if (tipo !== 'danger') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.style.opacity = '0';
                        alertDiv.style.transform = 'translateY(-10px)';
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 300);
                    }
                }, 4000);
            }
        }

        // Event listeners y auto-update
        document.addEventListener('DOMContentLoaded', function() {
            // Campos que disparan auto-update
            const camposAuto = ['riesgo', 'lotes', 'promedio', 'stop'];
            
            camposAuto.forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) {
                    // Auto-update con delay
                    campo.addEventListener('input', function() {
                        clearTimeout(this.updateTimeout);
                        this.updateTimeout = setTimeout(() => {
                            actualizarStatus();
                        }, 500);
                    });
                    
                    // Update inmediato al salir del campo
                    campo.addEventListener('blur', actualizarStatus);
                }
            });

            // Validaciones en tiempo real - SIMPLIFICADAS
            const camposNumericos = document.querySelectorAll('input[type="number"]');
            camposNumericos.forEach(campo => {
                campo.addEventListener('input', function() {
                    // Solo validar cuando el usuario termine de escribir
                    // No interferir durante la escritura
                });
                
                // Validar solo al salir del campo para no interferir
                campo.addEventListener('blur', function() {
                    let valor = this.value;
                    
                    // Limpiar caracteres no v√°lidos
                    valor = valor.replace(/[^0-9.\-]/g, '');
                    
                    // Permitir solo un punto decimal
                    const partes = valor.split('.');
                    if (partes.length > 2) {
                        valor = partes[0] + '.' + partes.slice(1).join('');
                    }
                    
                    // Solo para campos que no permiten negativos
                    const allowNegative = ['stop', 'promedio', 'actual', 'precio_entrada', 'desde', 'hasta'];
                    if (!allowNegative.includes(this.id)) {
                        const num = parseFloat(valor);
                        if (num < 0) {
                            valor = Math.abs(num).toString();
                        }
                    }
                    
                    this.value = valor;
                });
            });

            // Auto-save en localStorage
            const saveFields = () => {
                const data = {};
                ['simbolo', 'riesgo', 'tipo', 'lotes', 'promedio', 'stop'].forEach(field => {
                    const element = document.getElementById(field);
                    if (element && element.value) {
                        data[field] = element.value;
                    }
                });
                try {
                    localStorage.setItem('tradingCalcData', JSON.stringify(data));
                } catch(e) {
                    // Ignore localStorage errors
                }
            };

            // Auto-load desde localStorage
            const loadFields = () => {
                try {
                    const data = JSON.parse(localStorage.getItem('tradingCalcData') || '{}');
                    Object.keys(data).forEach(field => {
                        const element = document.getElementById(field);
                        if (element) {
                            element.value = data[field];
                        }
                    });
                    if (data.riesgo) {
                        actualizarStatus();
                    }
                } catch (e) {
                    // Ignore errors
                }
            };

            // Load data on start
            loadFields();

            // Save data on change
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', saveFields);
            });

            // Mostrar tip inicial
            setTimeout(() => {
                if (document.getElementById('resultado').textContent.includes('Setup data')) {
                    alerta('info', 'üí° Tip: Start by setting Symbol and Total Risk');
                }
            }, 1500);
        });
    </script>
</body>
</html>
